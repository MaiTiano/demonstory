Do._isay=function(){(function(d){d.fn.iframePostForm=function(g){var f,k,h,e=true,j;g=d.extend({},d.fn.iframePostForm.defaults,g);if(!d("#"+g.iframeID).length){d("body").append('<iframe id="'+g.iframeID+'" name="'+g.iframeID+'" style="display:none" />')}return d(this).each(function(){h=d(this);h.attr("target",g.iframeID);h.submit(function(){e=g.post.apply(this);if(e===false){return e}j=d("#"+g.iframeID).load(function(){f=j.contents().find("body");if(g.json){var l=f.text();try{k=d.parseJSON(l)}catch(m){}k=k||""}else{k=f.html()}g.complete.apply(this,[k]);j.unbind("load");setTimeout(function(){f.html("")},1)})})})};d.fn.iframePostForm.defaults={iframeID:"iframe-post-form",json:false,post:function(){},complete:function(e){}}})(jQuery);(function(d){d.fn.get_selection=function(){var m=this[0];if("selectionStart" in m){var f=m.selectionEnd-m.selectionStart;return{start:m.selectionStart,end:m.selectionEnd,length:f,text:m.value.substr(m.selectionStart,f)}}else{if(document.selection){m.focus();var j=m._saved_range||document.selection.createRange();var k=m.createTextRange();var o=k.duplicate();o.moveToBookmark(j.getBookmark());k.setEndPoint("EndToStart",o);if(j==null||k==null){return{start:m.value.length,end:m.value.length,length:0,text:""}}var n=j.text.replace(/[\r\n]/g,".");var g=m.value.replace(/[\r\n]/g,".");var h=g.indexOf(n,k.text.length);return{start:h,end:h+n.length,length:n.length,text:j.text}}else{return{start:m.value.length,end:m.value.length,length:0,text:""}}}};d.fn.set_selection=function(f,k){var j=this[0];if("selectionStart" in j){j.focus();j.selectionStart=f;j.selectionEnd=k}else{if(document.selection){j.focus();var h=j.createTextRange();var g=f;for(i=0;i<g;i++){if(j.value[i]&&j.value[i].search(/[\r\n]/)!=-1){f=f-0.5}}g=k;for(i=0;i<g;i++){if(j.value[i]&&j.value[i].search(/[\r\n]/)!=-1){k=k-0.5}}h.moveEnd("textedit",-1);h.moveStart("character",f);h.moveEnd("character",k-f);h.select()}}return this.get_selection()};d.fn.replace_selection=function(g){var j=this[0];selection=this.get_selection();var f=selection.start;var h=f+g.length;j.value=j.value.substr(0,f)+g+j.value.substr(selection.end,j.value.length);this.set_selection(f,h);return{start:f,end:h,length:g.length,text:g}};d.fn.wrap_selection=function(e,k,j,g){var h=this.get_selection().text;var f=this.replace_selection(e+h+k);if(j!==undefined&&g!==undefined){f=this.set_selection(f.start+j,f.start+j+g)}else{if(h==""){f=this.set_selection(f.start+e.length,f.start+e.length)}}return f}}(jQuery));window.Do=window.Do||function(d){typeof d=="function"&&setTimeout(d,0)};Do.add_js=function c(e){var d=document.createElement("script");d.src=e;document.getElementsByTagName("head")[0].appendChild(d)};Do.add_css=function a(f,e){var d=document.createElement("link");d.rel="stylesheet";d.href=f;document.getElementsByTagName("head")[0].appendChild(d)};Do.check_js=function b(d,f){var e=d();if(e){f(e)}else{setTimeout(function(){b(d,f)},33)}};(function(){var y=140,w="#dialog",m="textarea",h=".msg a",u="#isay-counter",g=".btn",d=".btn-group",G=".btn .bn-flat",x="#isay-act-field",v="isay-disable",D="isay-processing",f="isay-processed",s="active",B="focus",A="acting",F="error",e;var p=$("#tmpl-isay-act-field").html();var q,E,z,n;function l(I,J){return p.replace("{bd}",I).replace("{hd}",(J||""))}var H=Do.ISay={actions:{},initials:{},setField:function(){return q.addClass(A).find(x).html(l.apply(this,arguments))},hideField:function(){return q.removeClass(A)},fieldMsg:function(I,J){return this.setField('<div class="'+I+'">'+J+"</div>")},doAct:function(I,J){var K=this.actions;if(I&&I in K){q.addClass(s);this._acted=false;this._acting=I;K[I](J)}},done:function(I){this._acted=true},cancel:function(I){var J,K=$("input[name=uploaded]",q);q.removeClass(A);$("#iframe-post-form").unbind("load").attr("src","javascript:void(0);");if((J=this.imageUploadXHR)&&J.abort){J.abort();this.imageUploadXHR=null}if(K.length>0){K.remove()}delete this._acting;this.validate()},close:function(){this.cancel();E[0]._closed=true;E.height("").val("");z.show();q.removeClass(s);$(u).html("")},check:C,validate:r,enable:k,disable:t,init:function(K){var J=this;var I=$("#db-isay");var M=I[0];if(!M||M._inited){return}M._inited=true;J.root=q=I;J.node_label=z=I.find("label"),J.node_textarea=E=I.find(m),J.node_submit=n=I.find(":submit");for(var L in this.initials){this.initials[L]()}J.textarea_clone=e=E.clone().addClass("abs-out").attr("tabindex","-1");E.removeAttr("name");e.attr("id","isay-cont-clone").appendTo(E.parent());C();I.find("form").submit(function(N){r();if(I.hasClass(v)||(H._acting&&!H._acted)){N.preventDefault();return}t()});E.bind("keyup input",C).focus(function(){z.hide();E[0]._closed=false;I.addClass(s).addClass(B)}).blur(function(N){I.removeClass(B);C(N)}).focus();if(K){j(K)}I.delegate(".isay-close","click",function(N){H.close();return false}).delegate(".isay-cancel","click",function(N){H.cancel();N.preventDefault()}).delegate("a","click",function(P){var O=P.currentTarget;var N=O.getAttribute("href");if(N==="#"||N==="javascript:;"||!N){P.preventDefault()}j(O)}).delegate("label","click",function(P){var N=$(P.currentTarget).attr("for");var O=N&&document.getElementById(N);O&&O.focus&&O.focus()})}};function k(){if(H.acting&&!H._acted){return}q.removeClass(v);n.removeAttr("disabled")}function t(){q.addClass(v);n.attr("disabled",true)}function r(M){if(typeof M=="undefined"){M=o()}var N=M.replace(/(^|[^"'(=])((http|https)\:\/\/[\.\-\_\/a-zA-Z0-9\~\?\%\#\=\@\:\&\;\*\+]+\b[\?\#\/\*]*)/ig,"http://dou.bz/XXXXXX").length;var J="_acting" in H;var K=H._acted===true;var L=$(u);if(N>y||(!J&&N<1)||(J&&!K)){t()}else{k()}var I=y-N;if(I<0){L.html("<strong>"+I+"</strong>")}else{if(I<11){L.html(I)}else{L.html("")}}}function C(L){var K=E,J;var M=o(L&&L.target);var I=K.attr("data-minheight")||36;r(M);if(M||q.hasClass(B)){z.hide()}else{z.show()}J=e.val(M).height(0).scrollTop(10000).scrollTop();K.css("height",Math.min(Math.max(J,I),250))}function o(I){var J=I?I.value:E[0].value;return J?$.trim(J):""}function j(J){var I=J.getAttribute("data-action");I&&H.doAct(I,J)}})();(function(d){d.initials.mention=function(){Do.check_js(function(){return $.fn.tagsug&&window.Mustache},function(){var f=d.root.find("p.mention-highlighter");d.node_textarea.tagsug({url:"https://api.douban.com/shuo/in/complete?alt=xd&count={max}&callback=?&word=",highlight:true,highlighter:f});var e=/&nbsp;/g;d.node_textarea.parents("form").submit(function(j){var k=d.textarea_clone;var h=k.val();var g=f.find("code");g.each(function(l,m){h=h.replace($(m).text(),"@"+m.getAttribute("data-id"))});k.val(h)})})}})(Do.ISay);(function(e){var h="active";var j=e.validate;var d='<input type="text" id="isay-inp-url" value="http://" class="url" name="url"><span class="bn-flat"><input type="button" value="添加" class="bn-preview"></span>';e.initials.share=function(){e.root.delegate(".bn-preview","click",function(l){var k=$("#isay-inp-url");k.length&&f($.trim(k.val()));l.preventDefault()})};e.actions.share=function(){e.setField(d);var k=$("#isay-inp-url");function l(){if($.trim(k.val())){k.prev().hide();return true}else{k.prev().show()}}k.focus(function(m){k.closest("div").addClass(h)}).blur(function(m){k.closest("div").removeClass(h)}).keypress(function(m){if(m.keyCode==13){m.preventDefault();m.stopPropagation();f($.trim(this.value))}else{l()}}).bind("input",l)[0].focus();k[0].select();j()};function g(p){var m=p[0];if(!m){return}var n=document.createElement("span");n.className=p[0].className;n.innerHTML=p.val().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");n=$(n).css({position:"absolute",visibility:"hidden"});p.after(n);var l=n.width()+10;var k=Math.max(Math.min(l+4,500),200);n.remove();p.width(l).mouseenter(function(o){if(p.hasClass("field-title")){p.addClass("editable-over")}}).mouseleave(function(o){$(this).removeClass("editable-over")}).click(function(o){if(p.hasClass("field-title")){p.width(k);p.removeClass("field-title").removeClass("editable-over").focus().select()}}).blur(function(q){var o=$.trim(this.value);if(!o){e._acted=false}else{e._acted=true;p.addClass("field-title")}e.validate()}).keyup(function(q){var o=$.trim(this.value);if(o){e.enable()}else{e.disable()}if(q.keyCode===13){q.preventDefault();q.stopPropagation();if(o){this.blur();e.node_submit.focus()}}}).keypress(function(o){if(o.keyCode===13){o.preventDefault();o.stopPropagation()}})}function f(k,l){if(!k){return}e.fieldMsg("waiting","正在获取网址信息...");e.node_textarea.focus();$.post("/j/misc/get_url_info",{url:k,ck:get_cookie("ck")},function(m){var o,p;if(m.r){p=m.title;if(p.length>40){p=p.substring(0,40)+"..."}var n=e.setField(m.url||k,'<div class="hd"><input class="field-title" name="title" maxlength="40"></div><input type="hidden" name="url"><input type="hidden" name="t" value="I">');n.find("input[name=url]").val(m.url);g(n.find("input.field-title").val(m.title));e._acted=true;j()}else{e.fieldMsg("error",(m.error||"获取网址信息失败")+'。 <a href="javascript:void(0);" data-action="share">重新输入</a>')}},"json")}})(Do.ISay);(function(e){var g=typeof FileReader!=="undefined",h=function(k){return Object.prototype.toString.call(k)==="[object Function]"};function d(k){if(!(this instanceof d)){return new d(k)}this.imageFile=k}d.isSupported=g;var f={},j=function(m,n,l){f[m]=n;if(f.dataURI){var k=new Image();k.onload=function(){f.width=k.width;f.height=k.height;l(f)};k.src=f.dataURI}};d.prototype.getInfo=function(m){var k=this,n=k.imageFile,l;m=h(m)?m:function(){};l=new FileReader();l.onload=function(o){j("dataURI",o.target.result,m)};l.readAsDataURL(n)};e.ImageFileInspector=d})($);(function(e){var f="addEventListener" in document&&"onpaste" in document;function g(h){return Object.prototype.toString.call(h)==="[object Function]"}function d(j,h){if(!(this instanceof d)){return new d(j,h)}if(typeof j==="string"){return new d(document.getElementById(j),h)}if(!j||j.nodeType!==1){throw Error("need a dom node")}this.node=j;this.options=h||{};this._logMessage="";this._init()}d.isSupported=f;d.prototype={constructor:d,_init:function(){var h=this;h.node.addEventListener("paste",function(j){return h._pasteHandler(j)},false)},_log:function(h){this._logMessage+=h+"\n"},print:function(){if(typeof console!=="undefined"&&console.log){console.log(this._logMessage)}},_pasteHandler:function(q){var s=this,h=q.clipboardData,n,l,p,r,j,k=0,m,o;if(!h||!(n=h.items)||(j=h.getData("Text"))){s._log("sorry, browser not support");return}if((m=n.length)>0){for(;k<m;k++){if(n[k].type.indexOf("image")>=0){l=n[k];break}}if(l){p=l.getAsFile();r=new $.ImageFileInspector(p);r.getInfo(function(t){if((o=s.options.complete)&&g(o)){t.blob=p;o(t)}})}else{s._log("image is not found in clipboard")}}}};e.PasteToImage=d})($);(function(e){var k,d,h=3000000,j=128;function g(){d.replaceWith(d.clone(false));d=$("#isay-upload-inp");d.change(function(){if(this.value!==""){k.submit();k[0].submit();g()}})}function f(q){var p=q.width,m=q.height,l,r;if(r=e.imageUploadXHR){r.abort();e.imageUploadXHR=null}if((q.blob||q.file).size>h){e.fieldMsg("error","图片超过3M，请换一张图片");return}if((l=Math.max(p,m))>j){if(l===p){p=j;m=j/l*m}else{m=j;p=j/l*p}}e.setField('<img width="'+p+'" height="'+m+'" src="'+q.dataURI+'" /><div id="__paste_image_tmp__" class="waiting">正在更新图片信息...</div>');e.doAct("pic_xhr",$("#__paste_image_tmp__"));var o=new FormData(),r=new XMLHttpRequest(),n;o.append("image",q.blob||q.file);o.append("ck",k.get(0).ck.value);r.open("POST",k.attr("action"),true);r.onreadystatechange=function(){if(r.readyState===4&&r.status>=200&&r.status<400){e.imageUploadXHR=null;n=JSON.parse(r.responseText);$("#__paste_image_tmp__").removeClass("waiting").html('<input type="hidden" name="uploaded" value="'+n.url+'">');e.done();e.validate()}};r.send(o);e.imageUploadXHR=r}e.initials.pic=function(){k=$("#isay-upload");d=$("#isay-upload-inp");k.iframePostForm({json:true,post:function(){e.fieldMsg("waiting","正在上传...")},complete:function(n){d.val("");var m=n&&n.url;if(!m){l(n.msg||"上传失败");return}e.setField('<div class="waiting" style="padding-left:0;"><img src="{src}"></div><input type="hidden" name="uploaded" value="{src}">'.replace(/{src}/g,m));e.done();e.validate()}});d.change(function(){var n=this.files;if(n&&n.length){var m=n[0];if(m.size>h){l("图片超过3M");return}}if(this.value!==""){k.submit();k[0].submit();e.node_textarea.focus();g()}});if($.PasteToImage.isSupported){$.PasteToImage(e.node_textarea.get(0),{complete:f})}function l(m){e.fieldMsg("error",m+'，<a href="javascript:;" data-action="pic">点此重试</a>');k.css({left:m.length+1.7+"em",top:-40+"px"})}};e.actions.pic=function(m){var l=e;e.hideField();k.css({left:"",top:""});if(m&&m.id=="isay-upload-inp"&&m.value){k.submit();k[0].submit();g()}};e.initials.dargAndDrop=function(p){e.initials.dargAndDrop=$.noop;if(!("addEventListener" in document)||!("ondrag" in document)){return}var l=e,m=$(),n=Array.prototype.slice,o=false;p.unbind("dragenter");document.addEventListener("dragenter",function(q){var s;o=false;if(q.dataTransfer&&(s=q.dataTransfer.types)&&(s=n.call(s))&&s.indexOf("Files")<0){return}o=true;if((m=m.add($(q.target))).length>1){return}var r;l.init();e.hideField();if((r=l.root.find(".item")).find(".drag-tips").length===0){$('<div class="drag-tips">拖拽图片到这里，直接上传</div>').bind("dragenter dragover",function(t){t=t.originalEvent;$(this).addClass("over");t.stopImmediatePropagation();t.preventDefault();t.dataTransfer.dropEffect="copy"}).bind("dragleave",function(t){t=t.originalEvent;$(this).removeClass("over");t.stopImmediatePropagation()}).bind("drop",function(t){t=t.originalEvent;t.preventDefault();var u,v;if(u=t.dataTransfer.files[0]){v=new $.ImageFileInspector(u);v.getInfo(function(w){w.file=u;f(w)})}r.removeClass("drag");m=$()}).appendTo(r)}r.addClass("drag");q.dataTransfer.dropEffect="none";q.preventDefault()},true);document.addEventListener("dragover",function(q){if(o===true){q.dataTransfer.dropEffect="none";q.preventDefault()}},true);document.addEventListener("dragleave",function(q){if((m=m.not($(q.target))).length===0){l.root&&l.root.find(".item").removeClass("drag")}},true)}})(Do.ISay);(function(d){d.actions.topic=function(){var l=d.node_textarea;var f=l[0],e=f.value.length;f.focus();var k=f.value,g=l.get_selection(),j=g.text;start=g.start,end=g.end;if(k.charAt(start-1)=="#"&&k.charAt(end)=="#"){return d.done()}var h="#"+(j||"话题")+"#";f.value=k.substring(0,start)+h+k.substring(end,e);if(j===""){l.set_selection(start+1,start+3)}d.done()};d.initials.topic=function(){var f=d.node_textarea;var e=f[0];if(document.selection){f.bind("keyup mousedown mouseup focus",function(g){this._saved_range=document.selection.createRange()})}}})(Do.ISay)};if("add" in Do){Do("common",function(){Do._isay()})}else{Do._isay()};